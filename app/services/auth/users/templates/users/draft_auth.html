<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auth (draft)</title>
    <style>
            body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
            form { margin: 12px 0; }
            label { display: block; margin: 6px 0; }
            input[type="email"], input[type="password"] { width: 320px; }
            .msg { margin-top: 8px; color: #444; }
            .msg.error { color: #b00020; }
            .msg.success { color: #006400; }
    </style>
  </head>
  <body>
    <header>
      {% if user_info %}
        <a href="{% url 'account_profile_edit' %}">Редактировать аккаунт</a>
        {% if user_info.first_name or user_info.last_name %}
          <p>Привет, {{ user_info.first_name }} {{ user_info.last_name }}!</p>
        {% else %}
          <p>Привет, noname!</p>
        {% endif %}
        <p>Email: {{ user_info.email }}</p>
        {% if yandex_suggested %}
          <div style="margin-top: 8px;
                      padding: 8px;
                      border: 1px dashed #aaa;
                      max-width: 520px">
            <strong>Предложение из Yandex ID:</strong>
            <div>
              Имя: <em>{{ yandex_suggested.first_name|default:"—" }}</em>
            </div>
            <div>
              Фамилия: <em>{{ yandex_suggested.last_name|default:"—" }}</em>
            </div>
            <button id="applyYandexBtn" style="margin-top: 6px;">Применить имя и фамилию</button>
            <div id="applyYandexMsg" class="msg"></div>
          </div>
        {% endif %}
        {% if github_suggested %}
          <div style="margin-top: 8px;
                      padding: 8px;
                      border: 1px dashed #aaa;
                      max-width: 520px">
            <strong>Предложение из GitHub:</strong>
            <div>
              Имя: <em>{{ github_suggested.first_name|default:"—" }}</em>
            </div>
            <div>
              Фамилия: <em>{{ github_suggested.last_name|default:"—" }}</em>
            </div>
            <button id="applyGithubBtn" style="margin-top: 6px;">Применить имя и фамилию</button>
            <div id="applyGithubMsg" class="msg"></div>
          </div>
        {% endif %}
        <br />
        <form id="logoutForm" action="{% url 'logout' %}" method="post">
          {% csrf_token %}
          <button type="submit">Выйти</button>
        </form>
        <div id="logoutMessage" class="msg"></div>
      {% else %}
        <a href="{% url 'yandex_auth' %}">Войти через Yandex ID</a>
        <a href="{% url 'github_auth' %}">Войти через GitHub</a>
        <br />
        <br />

        <h2>Или зарегистрируйтесь по электронной&nbsp;почте</h2>
        <form id="emailRegistrationForm">
          <label for="email">Email:</label>
          <input type="email"
                 id="email"
                 name="email"
                 required
                 value="user@example.com" />

          <label for="password">Пароль (Password2025):</label>
          <input type="password"
                 id="password"
                 name="password"
                 required
                 value="Password2025"
                 autocomplete="new-password" />

          <label for="passwordAgain">Повторите пароль:</label>
          <input type="password"
                 id="passwordAgain"
                 name="passwordAgain"
                 required
                 value="Password2025" />

          <label>
            <input type="checkbox" name="acceptTerms" id="acceptTerms" required checked />
            Я принимаю условия
          </label>
          <button type="submit">Зарегистрироваться</button>
        </form>
        <div id="registerMessage" class="msg"></div>

        <h2>Или войдите по электронной&nbsp;почте</h2>
        <form id="emailLoginForm">
          <label for="loginEmail">Email:</label>
          <input type="email"
                 id="loginEmail"
                 name="email"
                 required
                 value="user@example.com" />

          <label for="loginPassword">Пароль:</label>
          <input type="password"
                 id="loginPassword"
                 name="password"
                 required
                 autocomplete="new-password"
                 value="Password2025" />
          <br />
          <br />
          <button type="submit">Войти</button>
        </form>
        <div id="loginMessage" class="msg"></div>
      {% endif %}

      <br />
      <a href="/admin" target="_blank">admin</a>
    </header>

    <script>
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      const csrftoken = getCookie('csrftoken');

      const regForm = document.getElementById('emailRegistrationForm');
      const regMsg = document.getElementById('registerMessage');
      if (regForm) {
        regForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          regMsg.textContent = '';
          regMsg.className = 'msg';
          const payload = {
            email: regForm.email.value.trim(),
            password: regForm.password.value,
            passwordAgain: regForm.passwordAgain.value,
            acceptTerms: regForm.acceptTerms.checked,
          };
          try {
            const resp = await fetch('{% url "register_user" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken || ''
              },
              body: JSON.stringify(payload)
            });
            const data = await resp.json();
            if (resp.ok && data.status === 'ok') {
              regMsg.textContent = 'Регистрация прошла. Проверьте почту для активации.';
              regMsg.className = 'msg success';
            } else {
              regMsg.textContent = data.message || 'Ошибка регистрации';
              regMsg.className = 'msg error';
            }
          } catch (err) {
            regMsg.textContent = 'Сетевая ошибка';
            regMsg.className = 'msg error';
          }
        });
      }

      const loginForm = document.getElementById('emailLoginForm');
      const loginMsg = document.getElementById('loginMessage');
      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          loginMsg.textContent = '';
          loginMsg.className = 'msg';
          const payload = {
            email: loginForm.email.value.trim(),
            password: loginForm.password.value,
          };
          try {
            const resp = await fetch('{% url "login" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken || ''
              },
              body: JSON.stringify(payload)
            });
            const data = await resp.json();
            if (resp.ok && data.status === 'ok') {
              loginMsg.textContent = 'Вход выполнен.';
              loginMsg.className = 'msg success';
              // Обновляем страницу, чтобы увидеть состояние авторизованного пользователя
              setTimeout(() => window.location.reload(), 400);
            } else {
              loginMsg.textContent = data.message || 'Ошибка входа';
              loginMsg.className = 'msg error';
            }
          } catch (err) {
            loginMsg.textContent = 'Сетевая ошибка';
            loginMsg.className = 'msg error';
          }
        });
      }

      const logoutForm = document.getElementById('logoutForm');
      const logoutMsg = document.getElementById('logoutMessage');
      if (logoutForm) {
        logoutForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          logoutMsg.textContent = '';
          logoutMsg.className = 'msg';
          try {
            const resp = await fetch('{% url "logout" %}', {
              method: 'POST',
              headers: { 'X-CSRFToken': csrftoken || '' }
            });
            if (resp.ok) {
              logoutMsg.textContent = 'Вы вышли из аккаунта';
              logoutMsg.className = 'msg success';
              setTimeout(() => window.location.reload(), 300);
            } else {
              logoutMsg.textContent = 'Ошибка выхода';
              logoutMsg.className = 'msg error';
            }
          } catch (err) {
            logoutMsg.textContent = 'Сетевая ошибка';
            logoutMsg.className = 'msg error';
          }
        });
      }

      const applyBtn = document.getElementById('applyYandexBtn');
      const applyMsg = document.getElementById('applyYandexMsg');
      if (applyBtn) {
        applyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          applyMsg.textContent = '';
          applyMsg.className = 'msg';
          try {
            const resp = await fetch('{% url "apply_yandex_profile" %}', {
              method: 'POST',
              headers: { 'X-CSRFToken': csrftoken || '' }
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok && data.status === 'ok') {
              applyMsg.textContent = 'Обновлено: ' + (data.data.updated.join(', ') || 'нет изменений');
              applyMsg.className = 'msg success';
              setTimeout(() => window.location.reload(), 400);
            } else {
              applyMsg.textContent = (data && data.message) || 'Не удалось применить данные';
              applyMsg.className = 'msg error';
            }
          } catch (err) {
            applyMsg.textContent = 'Сетевая ошибка';
            applyMsg.className = 'msg error';
          }
        });
      }

      const applyGhBtn = document.getElementById('applyGithubBtn');
      const applyGhMsg = document.getElementById('applyGithubMsg');
      if (applyGhBtn) {
        applyGhBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          applyGhMsg.textContent = '';
          applyGhMsg.className = 'msg';
          try {
            const resp = await fetch('{% url "apply_github_profile" %}', {
              method: 'POST',
              headers: { 'X-CSRFToken': csrftoken || '' }
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok && data.status === 'ok') {
              applyGhMsg.textContent = 'Обновлено: ' + (data.data.updated.join(', ') || 'нет изменений');
              applyGhMsg.className = 'msg success';
              setTimeout(() => window.location.reload(), 400);
            } else {
              applyGhMsg.textContent = (data && data.message) || 'Не удалось применить данные';
              applyGhMsg.className = 'msg error';
            }
          } catch (err) {
            applyGhMsg.textContent = 'Сетевая ошибка';
            applyGhMsg.className = 'msg error';
          }
        });
      }
    </script>
  </body>
</html>
